name: RDP Watcher (Self-Healing)

on:
  schedule:
    - cron: '*/1 * * * *'  # Check every 1 minute
  workflow_dispatch:

jobs:
  self-healing-watchdog:
    runs-on: ubuntu-latest
    steps:
      - name: Restart watcher if needed
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const watcherWorkflow = 'rdp-watcher.yml';  // This file itself
            const mainWorkflow = 'main.yml';            // Your RDP workflow

            // --- Check watcher itself ---
            const watcherRuns = await github.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: watcherWorkflow,
              per_page: 1
            });
            const latestWatcher = watcherRuns.data.workflow_runs[0];
            if (!latestWatcher || latestWatcher.status === 'completed') {
              console.log("Watcher was canceled/completed. Restarting watcher...");
              await github.actions.createWorkflowDispatch({
                owner,
                repo,
                workflow_id: watcherWorkflow,
                ref: 'main'
              });
            }

            // --- Check main.yml workflow ---
            const mainRuns = await github.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: mainWorkflow,
              per_page: 1
            });
            const latestMain = mainRuns.data.workflow_runs[0];
            if (!latestMain || latestMain.status === 'completed') {
              console.log("RDP workflow is not running. Starting main.yml...");
              await github.actions.createWorkflowDispatch({
                owner,
                repo,
                workflow_id: mainWorkflow,
                ref: 'main'
              });
            } else {
              console.log(`RDP workflow is running. Status: ${latestMain.status}`);
            }
