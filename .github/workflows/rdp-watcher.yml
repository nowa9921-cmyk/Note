name: RDP Watcher (Self-Healing)

on:
  schedule:
    - cron: '*/1 * * * *'  # every 1 minute
  workflow_dispatch:

permissions:
  actions: write  # Important to allow dispatch

jobs:
  self-healing-watchdog:
    runs-on: ubuntu-latest
    steps:
      - name: Self-Healing Watchdog
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Watcher workflow file
            const watcherWorkflow = 'rdp-watcher.yml';
            // RDP workflow file
            const mainWorkflow = 'main.yml';

            // --- Function to dispatch workflow ---
            async function dispatchWorkflow(workflow) {
              console.log(`Dispatching workflow: ${workflow}`);
              await github.actions.createWorkflowDispatch({
                owner,
                repo,
                workflow_id: workflow,
                ref: context.ref
              });
            }

            // --- Check watcher ---
            const watcherRunsResp = await github.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: watcherWorkflow,
              per_page: 1
            });
            const latestWatcher = watcherRunsResp.data.workflow_runs[0];
            if (!latestWatcher || latestWatcher.status === 'completed') {
              console.log("Watcher is not running or completed. Restarting watcher...");
              await dispatchWorkflow(watcherWorkflow);
            }

            // --- Check main.yml workflow ---
            const mainRunsResp = await github.actions.listWorkflowRuns({
              owner,
              repo,
              workflow_id: mainWorkflow,
              per_page: 1
            });
            const latestMain = mainRunsResp.data.workflow_runs[0];
            if (!latestMain || latestMain.status === 'completed') {
              console.log("RDP workflow is not running. Starting main.yml...");
              await dispatchWorkflow(mainWorkflow);
            } else {
              console.log(`RDP workflow is already running. Status: ${latestMain.status}`);
            }
